![](https://upload-images.jianshu.io/upload_images/19551947-1e0cca00c012c8ba?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

课程链接：[GAMES102几何建模与处理](https://www.bilibili.com/video/BV1NA411E7Yr?p=8)

课程讲师：刘利刚

公众号：AlbertLiDesign

Github实现（C#）：https://github.com/AlbertLiDesign/ALGeo

## 三角网格的理解

![图1. 网格的两种观点](https://upload-images.jianshu.io/upload_images/19551947-15daf3c20807ece4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

三角网格有两个观点，第一个观点是说，点是从曲面上采样的，我们把曲面上相邻的点连成三角形，就构成一张水密的**分片线性**的表达，所以它是对原曲面的逼近，每个三角形都是一张平面，所以它是一种**分片线性**的表达。所以从曲面的逼近来看，网格是一个更简单的，低次的曲面，只有$C^0$连续，它是用一个分片线性逼近函数去逼近一个光滑曲面，如果从泰勒展开的角度也可以看作是网格点处的一阶展开，用局部的平面片去逼近了原来的曲面，也可以把它叫做离散曲面。

另一个观点是认为，网格本质上是一个**图（Graph）**，它只是有一些线和点构成的一张图，就如同我们在数据结构中学到的图结构。我们先从平面上得到一个平面图，然后再把点映射到空间中的某个位置，在拓扑学中叫**提升（lifting）**，即拓扑结构不变，只是把顶点的位置从二维平面变到三维空间，只要有一个函数能把这些点映射到空间，就能形成一张复杂的曲面，所以网格本质上是**二维图的空间映射**，因此它本质上是**二维流形**，可以看作是拓扑学中从低维到高维的嵌入（提升），二维平面图可以看作是一个参数域，通过参数化变到空间中的曲面。

### 网格的数据结构
要想理解三角网格的结构，要理解什么是图结构。图结构由顶点和边组成，生活中有很多的用处，比如我们可以把城市道路看作是边，把十字路口看作是节点，那么就能得到一个城市地图的抽象，去找从一个节点到另外一个节点的最短路径就可以利用图中的算法，这也就是生活中经常使用的导航。

网格的表示可以写成$G={V,E,F}$，这里$V$是顶点集合，$E$是边集合，$F$是多边形集合，对于三角网格，$F$表达的就是三角形集合，**任意多边形网格都可以转化成三角网格**。需要注意的是，**已知顶点集合和边集合（或面集合）可以推出另一个集合**，OBJ是最简单的网格表示格式，其表示方法如下

```
v 1.0 0.0 0.0
v 0.0 1.0 0.0
v 0.0 -1.0 0.0
v 0.0 0.0 1.0
f 1 2 3
f 1 4 2
f 3 2 4
f 1 3 4
```

只存储了顶点信息和面的信息，$v$表示顶点，后面的三个浮点数为三维空间中的坐标，$f$表示面，后面的三个正数表示由第几号顶点构成的三角形。例如$f 1 2 3$表示由第1、2、3号顶点构成了一张三角面片。由顶点信息和面信息我们就可以推出边的信息，只需要对去除重复的边即可。给定顶点坐标和边的连接关系，也可以推出面的信息，只需要去访问与一条边相邻的边即可，如此循环下去最后会找回到自身，一张面也就得到了。给定边集合和面集合无法推出顶点信息，因为它们都是拓扑信息，缺乏几何信息。
### 非流形结构

![图2. a. 非流形边。b.非流形点。c.非流形点。](https://upload-images.jianshu.io/upload_images/19551947-1d4123213aee8cac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600)

对于一个曲面上的任意一点，它的无穷小邻域拓扑同胚于一个小平面，如果不是一个小平面，那么它就是**非流形**。例如图2(b)，如果我们沿着中间的顶点画一个圈会发现交于两个小平面，因此这个点是一个**非流形顶点**，其他同理。非流形结构很麻烦，在大多数的几何处理都不讨论非流形结构，微分几何讨论的是流形结构，故非流形结构不在本课程的讨论范围中。

## 三角网格编程初步
一些对三角网格复杂的操作离不开图的数据结构，在这里我们介绍一种常用的数据结构——**半边数据结构（Half-edge data structure）**。半边数据结构的思想是**把一条边变成两条半边**，它是以边为中心的存储，半边会存储**它的末顶点、它的下一条半边以及它的面**，网上能找到很多关于半边数据结构的介绍。半边数据结构的目的是**提高点线面的查询或增删改操作的效率**。

![图3. 半边数据结构](https://upload-images.jianshu.io/upload_images/19551947-9b1c332c5982a733.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)


下面是一个半边数据结构，一条半边（图3中的红色半边）存储了一个顶点（半边指向的末顶点），它的另外一条半边（方向相反的opposite halfedge），它所指向的面（指向的incident facet）以及它的下一条半边(next halfedge)；一个顶点只需要存储它的顶点以及它所在的半边即可；一张面仅需要存储一条半边。

``` c
struct HE_edge
{
    HE_vert* vert;
    HE_edge* pair;
    HE_face* face;
    HE_edge* next;
};
struct HE_vert
{
    double x;
    double y;
    double z;
    HE_edge* edge;
};
struct HE_face
{
    HE_edge8 edge;
};
```

那么对于这样的结构，我们是否能够很快速地找到所需要的信息呢？答案是肯定的。
- 由一条半边找两个顶点：半边已存储末顶点可以直接访问，而它的相反半边的末顶点其实就是它自身的始顶点，因此查找始顶点只需要访问该半边的相反半边（pair）的末顶点即可。
- 由一条半边找两邻面：半边已存储它所在的面，同理，要想找到它的另一个邻面，可以直接访问它的相反半边存储的邻面即可。
- 由一张面找所有半边：面已经存储一条半边，我们只需要不断地寻找这条半边的下一条半边，直到回到它自身，即可找到面内所有半边。
- 由顶点找所有半边：顶点已存储一条半边，我们找它的相反半边的next即可找到所有经过该顶点的半边。

代码如下：

``` c
// 由边找两顶点及两邻面
HE_vert* vert1 = edge->vert; // 末顶点
HE_vert* vert2 = edge->pair->vert; // 始顶点

HE_face* face1 = edge->face; //半边所在的面
HE_face* face2 = edge->pair->face; // 半边相邻的面

// 由面找其所有半边
HE_edge* edge = face->edge // 找到一张面的半边

do
{
    // do something with edge
    edge = edge->next;
}
while(edge != face->edge)

// 由顶点找其所有半边
HE_edge* edge = vert->edge;

do
{
    edge = edge->pair->next;
}
while(edge != vert->edge)
```

常用的几何处理库有：CGAL、Libigl、Meshlab、OpenMesh、PCL(Point Cloud Library)、TriMesh、DGtal等等。

## 曲线曲面的微分几何
### 曲线的微分几何

如图4，给定一条曲线$C(u)$，上面有一个点$p$，这里的曲线是一条光滑的参数型曲线，例如我们前面学过的贝塞尔曲线。

![图4. 给定的参数曲线](https://upload-images.jianshu.io/upload_images/19551947-634db700da8fde20.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

那么能得到下面的表达式（三维情况），
$$
p=C\left(u_{0}\right)=\left\{\begin{array}{l}
x=x\left(u_{0}\right) \\
y=y\left(u_{0}\right) \\
z=z\left(u_{0}\right)
\end{array}\right.
$$

那么在这个点处求导，

![图5. p点处的切向](https://upload-images.jianshu.io/upload_images/19551947-256907fb2a46906b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

我们知道对向量的求导、求积都是对分量的求导、求积，然后就变成了一个向量$C_u$，可以证明这个向量与曲线相切，切点为$p$。
$$
C_{u}=\frac{\partial C(u)}{\partial u}=\left(\begin{array}{l}
x^{\prime}(u) \\
y^{\prime}(u) \\
z^{\prime}(u)
\end{array}\right)
$$

![图6. p点处的TNB平面](https://upload-images.jianshu.io/upload_images/19551947-90b089de73def875.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

在微分几何里面我们还定义了$C_{u}$关于$u$的导数$C_{uu}$（即二阶导数），可以证明$C_{uu}$与$C_{u}$不是同向的，把它们两个做叉积就可以得到另外一个方向$B$，$B$被称为**从法**，将$B$与$C_u$再做叉乘，就能得到法向$N$。由于$C_u$就是切向所以我们记为$T$，这里我们会发现，$T$、$B$和$N$构成了一个互相垂直的直角坐标系，并且遵循右手系，在微分几何里成为**Frent frame**。我们说，如果一个点非退化，那么这个点处的切线、从法和法相就构成了一个正交的Frent标架。法相就是垂直于切线方向，从法则是指向屏幕里面，如果是空间曲线，我们可以通过找法向与切向构成的平面，再求该平面的法向即是从法。

![图7. p点处的曲率](https://upload-images.jianshu.io/upload_images/19551947-b53e80e75874df07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

微分几何中还有一个概念叫**曲率**$\kappa$，曲率是曲线在该点处弯曲程度的度量，是它的**密切圆（osculating circle，也叫曲率圆）的半径的倒数**。曲率越大，曲率圆越小，表示它弯的很厉害，直线的曲率为0，曲率半径无穷大。

曲率可以通过一些推导来计算，如下图所示

![图8. 曲率计算](https://upload-images.jianshu.io/upload_images/19551947-1ba3bc24c2ff526b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

需要注意的是，**曲率与参数化是无关的**，也就是说它是曲线的本身属性，即曲线的形状由每个点的曲率所唯一确定，但是相差一个刚性变换，即弯曲的方向可能不同。所以**曲率是刻画曲线的几何本身不变量**。

### 曲面的微分几何

![图9. 点p在曲面上的切向](https://upload-images.jianshu.io/upload_images/19551947-b094dfd21cfe8ad4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

曲面的微分几何会稍微复杂一点，如图9给出的一张曲面，给定点$p$，在三维中的曲面是二维流形，因此$p$的坐标是双参数的，这里用$(u_0,v_0)$表示。由于它有两个参数，因此要对两个分量进行偏导，有

$$
S(u, v)=\left(\begin{array}{l}
x(u, v) \\
y(u, v) \\
z(u, v)
\end{array}\right)
$$

![图10. 点p处的切平面](https://upload-images.jianshu.io/upload_images/19551947-20c44364e20d61d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

分别对$u, v$进行偏导后得到两个向量，这两个向量一定是不共线的，因此就可以张成一张平面，叫做**切平面**，切平面上过p点的任何一条线都与曲面有唯一交点，且都是曲面的切线。**切平面上有无数条切线，因此切线只有在给定的方向下才有意义。**

![图11. 点p处的法向](https://upload-images.jianshu.io/upload_images/19551947-51b8d1f015ecc866.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

有了切平面，我们就能求出点$p$的法向，即$S_u$与$S_v$的叉积，这就得到了曲面在$p$点处的法向。需要注意的是求得的法向要做归一化处理，即$||N|| = 1$。

![图12. N与T构成的平面与曲面交于一条平面曲线](https://upload-images.jianshu.io/upload_images/19551947-a0dc04194ac5cbd9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

我们以$N$和某一切向$T$够成一个平面，该平面会与曲面有一条交线，即图12中的黑色曲线，这条曲线就是一条平面曲线，有了平面曲线就可以定义它的一些参数，例如曲率，这个曲率就叫做**方向曲率**，它是随着方向变化而变化的。可以想象，如果这个$N$和$T$构成的平面，以$N$为转轴旋转，那么就能得到无穷多条交线，那么就会有无穷多个曲率，所以**在空间中讨论切向和曲率都是要指定方向的。**

#### 主曲率、高斯曲率与平均曲率
可以证明的是，在过曲面上一点的无穷多的曲率中，有两个方向的曲率至关重要，一个是**最大曲率**$\kappa _1$，一个是**最小曲率**$\kappa _2$，**并且这两个曲率的方向是相互垂直的**，对任意曲面都成立，它们成为**主曲率**。找到了两个主曲率了，根据欧拉公式，**其他方向的曲率可以表示为这两个主曲率的线性组合，并且组合系数相加刚好为$1$**，即
$$
\kappa = \kappa_1 cos^2\theta + \kappa _2 sin^2\theta
$$
$\theta$是该方向曲率与$\kappa _1$所构成的夹角。

![图13. 最小曲率与最大曲率的可视化](https://upload-images.jianshu.io/upload_images/19551947-ba9c4eccfa946105.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

图13展示了最小曲率和最大曲率的可视化，可以看到这两个曲率是相互正交的。

由这两个主曲率也可以定义其他的曲率，其中比较重要的曲率是**高斯曲率**，高斯曲率就是两个主曲率的乘积，
$$
\kappa = \kappa_1 \kappa_2
$$

![图14. 可展曲面](https://upload-images.jianshu.io/upload_images/19551947-652b25b8619ccf24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

高斯曲率也用来度量曲面的弯曲程度，它是一个等距变换不变量，即当曲面发生变形时，只要两点间的距离不发生改变，那么它就不会变。例如用一张纸，把它卷成一个圆柱或圆锥，这个纸上的度量都不会变化，仅做了弯曲。一个平面的高斯曲率，任何方向都是直线，所以高斯曲率为$0$，除此之外，圆柱和圆锥可以由平面卷起来而成，并没有发生撕裂和挤压，因此可以证明，圆锥和圆柱上的每个点的高斯曲率一定为0。反过来我们说，处处高斯曲率为$0$的曲面，即通过等距变换可以变成一个平面，那么它就被称为**可展曲面**。可展曲面可以被展成平面，并过程中不发生任何撕裂、挤压、变形。值得注意的是，还有一种可展曲面叫**切线面**，即一条空间曲线所有的切线所构造出的曲面，如图14所示。

还有另外一个曲率是**平均曲率**，即两个曲率的算术平均，

$$
\kappa = \frac{\kappa_1 + \kappa_2}{2}
$$

它也有一种特殊的性质，处处平均曲率为$0$的曲面叫做$极小曲面$，极小曲面的面积最小，例如生活中的肥皂泡。

在微分几何中还有一些概念，例如椭球点（elliptic），抛物点（parabolic）和双曲点（也叫马鞍点，hyperbolic）。椭球点的两个主曲率都大于$0$，抛物点是指最大主曲率大于$0$，最小主曲率等于$0$的点，双曲点的最大主曲率大于$0$，最小主曲率小于$0$，**极小曲面上的所有点都是马鞍点**。除此之外，对于球上一点，它的两个主曲率都相等且均大于$0$，平面上的两个主曲率都为$0$。

![图15. 微分几何中的各向同性与各向异性](https://upload-images.jianshu.io/upload_images/19551947-7c5071c5e3ded19a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

### 离散微分几何
微分几何是研究光滑曲面上一个无穷小邻域的微分属性，例如导数、曲率等性质。那么如何研究三角网格曲面呢？三角网格是分段的平面，即分片平面，对于一个三角网格上的顶点，它的邻域三角形不一定共面，那么曲面在这一点只有$C^0$连续，不光滑就不可微，不可微就没法去讨论它的微分属性，但是我们又知道，这些点是从一个光滑曲面上采样过来的点，那么它原本的曲面一定有它的微分属性，我们希望从采样点去估计出原曲面的微分属性。

![图16. 三角网格](https://upload-images.jianshu.io/upload_images/19551947-e75d0159c762a768.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

#### 法向估计
对于三角网格上一点，有若干个三角面与该点相邻，每张网格面都是平面且有各自的法向，那么该点的法向该如何定义的？一个简单的想法是直接将相邻面片的法向平均来得到，即顶点法向等于于它相邻的三角面的法向的平均（离散逼近）。当然也可以通过相邻的网格面来拟合出一张光滑曲面，再用光滑曲面的法向来近似它（连续逼近）。因此就有了两种方法论。

![图17. 连续逼近和离散逼近](https://upload-images.jianshu.io/upload_images/19551947-0b20b8a1dff7c955.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

连续逼近在早点有很多paper做过相关研究，我们更关心的是能否用离散方法来逼近它。上面说到可以用这个点周围的面片的法向来平均，但是每个三角形都不一样，因此需要加权平均，于是衍生出了各种加权的方法，例如面积权和顶点夹角权。
#### 曲率估计

![图18. 离散网格的平均曲率计算](https://upload-images.jianshu.io/upload_images/19551947-9e091c26b68f9ff9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

我们最关心的是曲率计算，这里主要给出结论，在计算曲率时我们使用Laplace-Beltrami定理来计算一个点的曲率，即对于顶点的1-邻域（1-ring，即与该点相邻的一圈网格面），取过该点的某一边相对的两个三角形的夹角$\alpha$与$\beta$的余切和作为权重，最后再除以一邻域的Voronoi面积的两倍，即可近似出这个点的平均曲率。

![图19. 离散网格的高斯曲率计算](https://upload-images.jianshu.io/upload_images/19551947-dcd74e6812c66fa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

同样，高斯曲率也可以有Gauss-Bonnet定理推导出，即一个点的高斯曲率等于$2\pi$减去三角形在过该点的角的和再除以Voronoi面积。

![图20. 高斯曲率的可视化](https://upload-images.jianshu.io/upload_images/19551947-ba07cfd08fac64ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

图20展示了高斯曲率的可视化，可以看到突出的部位高斯曲率会很大，接近平面的部位高斯曲率就会很小，越平的地方高斯曲率越小。

### 极小曲面

![图21. 极小曲面的例子](https://upload-images.jianshu.io/upload_images/19551947-b1feafe6ee9abcdd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

![图22. 极小曲面的例子](https://upload-images.jianshu.io/upload_images/19551947-0cce6abb2f0a8688.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

![图23. 极小曲面的例子](https://upload-images.jianshu.io/upload_images/19551947-b463590f07f6e0a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

![图24. 建筑中的极小曲面](https://upload-images.jianshu.io/upload_images/19551947-53e1419372fd315d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

![图25. 建筑中的极小曲面](https://upload-images.jianshu.io/upload_images/19551947-396b079b2405cf69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

前面提到，极小曲面就是平均曲率处处为$0$的曲面，它的每个点都是马鞍点，即两个主曲率一正一负。在实际应用中，建筑学中会用的比较多，屋顶使用极小曲面，由于它的面积最小，因此能够起到省材料的作用，其次，由于每个点都是马鞍点，即一个方向是向下弯另一个方向是向上翘，当下雨下雪时，水会顺着凹的方向流出，就不容易形成积水。因此有很多建筑的屋顶采用了极小曲面设计。

![图26. 极小曲面及平均曲率流](https://upload-images.jianshu.io/upload_images/19551947-5373e0dc0d678c91.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

上文我们提到了极小曲面的近似求解，即网格点与它1-邻域的重心。单独把1-邻域拿出来看，如图27所示，我们构造一个由点$P$出发指向它的1-邻域重心的向量$L$，我们让点$P$沿着$L$运动，对于任意开放网格，让每个点沿着各自的$L$运动迭代，即可得到一张极小曲面（注意要迭代地移动，每次移动$\lambda = 0.1$即可，不能直接移过去，不然很难收敛）。

![图27. 拉普拉斯算子](https://upload-images.jianshu.io/upload_images/19551947-d57dfc69c269f44d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

![图28. 离散平均曲率流](https://upload-images.jianshu.io/upload_images/19551947-28ff40d10549be8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

因此可以归纳出离散极小曲面的局部迭代法，如图29所示

![图29. 离散极小曲面的局部迭代法](https://upload-images.jianshu.io/upload_images/19551947-f59247ec5ac99d72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

前提是输入的曲面必须是开放的曲面，边界点保持固定，如果是封闭曲面那么该曲面会坍缩。另外，上述使用的拉普拉斯算子是均匀拉普拉斯算子，这可能会造成网格面自交，使用余切拉普拉斯算子能够避免这一情况。

![图30. 极小曲面局部迭代法的效果](https://upload-images.jianshu.io/upload_images/19551947-21e8fb48a2dd5d70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400)

